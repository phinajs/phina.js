<!doctype html>

<html>
  <head>
  </head>
  <body>
  </body>
</html>

<script src='../build/phina.js'></script>
<script>

phina.globalize();

var ASSETS = {
  image: {
    'tomapiko': '../assets/images/tomapiko_ss.png',
    'karasu': '../assets/images/karasu_ss.png',
  },
  spritesheet: {
    'tomapiko': '../assets/tmss/tomapiko.tmss',
    'karasu': '../assets/tmss/karasu.tmss',
  },
};
var SCREEN_WIDTH = 960;
var SCREEN_HEIGHT = 640;

phina.define("MainScene", {
  superClass: 'CanvasScene',

  init: function() {
    this.superInit({
      width: SCREEN_WIDTH,
      height: SCREEN_HEIGHT,
    });

    this.backgroundColor = 'hsl(200, 80%, 70%)';

    this.player = Player().addChildTo(this);
    this.player.setPosition(this.gridX.span(2), this.gridY.span(8));

    this.enemyGroup = CanvasElement().addChildTo(this);

    this.onpointstart = function() {
      this.player.fly();
    };
  },

  update: function(app) {
    if (app.ticker.frame % 30 === 0) {
      var enemy = Enemy().addChildTo(this.enemyGroup);
      var yIndex = Math.randint(0, 16);
      enemy.setPosition(this.gridX.span(18), this.gridY.span(yIndex));
    }

    this.enemyGroup.children.each(function(enemy) {
      if (this.player.hitTestElement(enemy)) {
        alert('game over');
        this.app.stop();
      }
    }, this);
  },
});

phina.define('Player', {
  superClass: 'Sprite',

  init: function(index) {
    this.superInit('tomapiko');
    this.scaleX = -1;
    this.anim = FrameAnimation('tomapiko').attachTo(this);
    this.anim.gotoAndPlay('fly');

    this.physical.gravity.set(0, 0.5);
  },

  fly: function() {
    this.physical.force(0, -10);
  },
});

phina.define('Enemy', {
  superClass: 'Sprite',

  init: function(index) {
    this.superInit('karasu');
    this.anim = FrameAnimation('karasu').attachTo(this);
    this.anim.gotoAndPlay('fly');

    this.vx = -10;
  },
  update: function() {
    this.x += this.vx;

    if (this.x < -100) {
      this.remove();
    }
  },
});



phina.main(function() {
  var app = GameApp({
    width: SCREEN_WIDTH,
    height: SCREEN_HEIGHT,
    assets: ASSETS,
    startLabel: location.search.substr(1).toObject().scene || 'title',
  });

  app.enableStats();
  app.run();
});



</script>